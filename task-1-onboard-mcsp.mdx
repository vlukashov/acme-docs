---
title: "Task 1: Onboard to MCSP User Management"
---

MCSP provides a comprehensive identity and access management (IAM) service, which consists of two independent services, authentication service, and authorization service. MCSP authentication service is powered by Acme Security Verify (ISV), which is a single-sign-on service and identity broker, and provides authentication token. User can be authenticated with built-in identity source, or with customer provided identity provider. MCSP authorization service integrates with ISV, manages access policy, provides authorization token, and policy decision endpoint (PDP) API.
Product service can adopt MCSP IAM to provide end user SSO and consistent access experience across all products in MCSP platform. 

![IAM](/images/iam.png)

This section describes the steps required to adopt MCSP IAM and login with default identity source, ACMEid for Commercial, and ISV built-in user directory for Fedramp. There is a minor integration difference to support login with customer provided identity provider, we will create a different task to describe the required steps on top of those common steps.

## Step 1: Request an OIDC Client

Open a [support ticket](https://github.acme.com/acme-saas-platform/dev-support/issues) and include the following minimum information:

- **Environment**: development, staging, pre-production, production, commercial, Fedramp, ProtectedB
- **OIDC redirect_uri**
- **Contact person emails**
- **Client ID** (if reusing a previously requested client)

MCSP will provide you with the OIDC client metadata, including:
- `client_id`
- `client_secret`
- Discovery URL

## Step 2: Update Product Registration Form

Follow this sample [link](https://github.acme.com/automation-paas-cd-pipeline/testpak-product-enablement/blob/master/resources/templates/product-registration.yaml#L65) to update the product registration form.

Update lines 65, 66, and 67 as illustrated:

```yaml
IAM:
  v2: true # this attribute is used to identify whether or not a product is using the MCSP IAM v2 integration
  clientID: client_id # the client_id value obtained in Step 1
```


## Step 3: Integrate with OIDC Client

Integrate with the OIDC client you received in Step 1 to initiate user login. This is where you check user security session and initiate new login if there is no existing authentication session.

### Step 3a: OIDC Relying Party Implementation

Your code acts as an OIDC relying party that:
- Redirects unauthenticated users to ISV to request authorization code

  This sample code assume that your codes does not handle Discovery URL programmatically. From browser, type the Discovery URL you got in step 1, a json file will display in the browser. From the json file, find those two values, authorization_endpoint, and token_endpoint.

  Your application need to pass following parameters to ISV authorization_endpoint:

  ```
  response_type=code
  scope=openid email
  redirect_uri= <the callback URL to receive authorization code>
  state=<some random characters. May store some info for tracking as it is returned as it is>
  client_id=<The client_id received from step 1>
  ```

  It is recommended to include optional PKCE parameters (see https://datatracker.ietf.org/doc/html/rfc7636)
  ```
  code_challenge_method=S256&code_challenge=p<some random challenge code>
  ```

  The URL is like:

``` 
  https://console-acme-stg.verify.acme.com/oauth2/authorize?
  client_id=3eb0......a48&
  scope=openid profile email&
  response_type=code&
  redirect_uri=https://sample.com/auth/login/callback&
  state=eyJyZXR1cm5UbyI....B0aW9uIjp7fX0&
  code_challenge_method=S256&code_challenge=6666666
  ```
 

- Exchange authorization code for JWT tokens

  Use previous received authorization code to exchange for OIDC access_token and id_token. If you include code_challenge in authorization code request, you must also include code_verifier in token request.

  Here is a sample curl request to exchange code for token

```bash
 curl -k -v -X POST -H 'Content-type: application/x-www-form-urlencoded'
 -d "grant_type=authorization_code&
     client_id=c.......d&
     client_secret=L....Ur&
     redirect_uri=https://example.com/callback&
     code=7777777&
     code_verifier=9999"
     https://console-acme-stg.verify.acme.com/oauth2/token
```

  
### Step 3b: Token Exchange

Invoke the MCSP IAM [token exchange API](https://pages.github.acme.com/acme-saas-platform/account-iam-apidoc/#tag/Authz-Management) to request MCSP authorization JWT token with ISV JWT.

To call token exchange API, you find know MCSP IAM API from the linked api doc. You can use either access_token or id_token from previous step as "jwt" parameter as shown below

```bash
curl -X 'POST' \
  'https://account-iam.platform.saas.acme.com/api/2.0/services/<instance id here>/token?' \
  -H 'accept: application/json' \
  -H 'Content-Type: application/json' \
  -d '{
  "jwt": "isv token"
}'
```

### Step 3c: Use MCSP JWT

Use the MCSP JWT as a bearer token to request user access to the requested web resource. 

```bash
curl -X 'POST' \
  'https://your-api' \
  -H 'accept: application/json' \
  -H 'Authorization: Bearer <MCSP token here>' 
```

### Step 3d: Validate MCSP token signature

call MCSP JWKS endpoint to retrieve signature validation key
```bash
curl -X 'GET' \
  'https://account-iam.platform.saas.acme.com/api/2.0/jwks' \
  -H 'accept: application/json'
  ```

## Next Steps
Once onboarding is complete, you can proceed to:
- [Login Button](task-2-login-button)
- [Metering](task-6-implement-metering)
